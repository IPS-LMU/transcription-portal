<tportal-popover
  #popoverRef
  (mouseenter)="popover.mouseIn = true"
  (mouseleave)="togglePopover(false)"
  [@fadeToggleRow]="popover.state"
  [borderColor]="getPopoverColor(popover.operation!)"
  [height]="popover.height"
  [ngStyle]="{
    width: popover.width + 'px',
    height: popover.height + 'px',
    'margin-top': popover.y + 'px',
    'margin-left': popover.x + 4 + 'px',
  }"
  [pointer]="popover.pointer"
  [width]="popover.width"
>
  @if (popover.operation !== undefined) {
    @if (popover.operation.time && popover.operation.time.start !== undefined && popover.operation.time.start > 0) {
      @if (popover.operation.isFinished && !popover.operation.lastRound?.lastResult?.available) {
        <p style="color: red">{{ 'popovers.results.last result unavailable' | transloco }}</p>
      }
      <div class="row g-0">
        <div class="col" style="font-size: 0.85rem">
          <i class="bi bi-clock" style="color: cornflowerblue"></i><span> {{ popover.operation.time.start | luxonFormat: 'DATETIME_SHORT' }}</span>
        </div>
        <div class="col text-end" style="font-size: 0.85rem">
          <i class="bi bi-hourglass" style="color: cornflowerblue"></i
          ><span> {{ calculateDuration(popover.operation.time, popover.operation) | time: 'true' }}</span>
        </div>
      </div>
    }
    @if (popover.operation.state === 'PROCESSING' && popover.operation.serviceProvider !== undefined) {
      <div class="service-preview">
        <div class="provided-by">{{ 'p.service provided by' | transloco }}</div>
        <a [href]="popover.operation.serviceProvider.homepageURL" style="display: block; vertical-align: middle" target="_blank">
          <img [src]="popover.operation.serviceProvider.logoURL" alt="EML Logo" class="service-logo" style="border: 1px solid lightgray" />
        </a>
        <div class="service-terms">
          <a [href]="popover.operation.serviceProvider.termsURL" target="_blank"
            ><i class="bi bi-journal-text"></i> {{ 'p.service terms' | transloco }}</a
          ><br />
          <a [href]="popover.operation.serviceProvider.homepageURL" target="_blank"><i class="bi bi-globe"></i> {{ 'g.homepage' | transloco }}</a
          ><br />
        </div>
        <i (click)="onReportIconClick(popover.operation)" class="bi bi-exclamation-circle report-issue"></i>
      </div>
      <div class="service-remarks">
        <ul>
          <li>{{ 'popovers.results.service remarks.processing time' | transloco }}</li>
          <li>{{ 'popovers.results.service remarks.about the result' | transloco }}</li>
          <li>{{ popover.operation.serviceProvider.dataStoragePolicy }}</li>
        </ul>
      </div>
      <div class="clearfix"></div>
    } @else if (popover.operation.rounds.length > 0) {
      <div style="overflow: hidden">
        <tportal-results-table
          #resultsTableComponent
          [visible]="popover.state === 'opened'"
          (previewClick)="onPreviewClick($event)"
          [operation]="popover.operation"
        ></tportal-results-table>
      </div>
    }
    @if (popover.operation.parsedProtocol.length > 0) {
      <div id="output-area">
        <div style="width: 100%; text-align: right; padding: 0; margin-bottom: 0">
          <button
            (click)="copyProtocolToClipboard(popover.operation.protocol)"
            class="btn btn-sm btn-outline-info"
            style="font-size: 11px; cursor: pointer; margin-bottom: 0"
          >
            <i class="bi bi-clipboard"></i> {{ 'p.copy to clipboards' | transloco }}
          </button>
        </div>
        <table class="table table-sm table-striped" id="output-table">
          <tbody>
            @for (item of popover.operation.parsedProtocol; track item) {
              <tr>
                <td>
                  @if (item.type === 'ERROR') {
                    <i class="bi bi-exclamation-circle" style="color: red"></i>
                  } @else {
                    <i class="bi bi-exclamation-triangle" style="color: orange"></i>
                  }
                </td>
                <td
                  [ngClass]="{
                    error: item.type === 'ERROR',
                    warning: item.type === 'WARNING',
                  }"
                >
                  {{ item.message }}
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  }
  @if (popover.operation === undefined && popover.task) {
    <div class="card mb-3">
      <div class="card-header">Task Options</div>
      <div class="card-body p-0">
        <table class="table table-striped table-sm options-info-table p-3 m-0">
          <tbody class="">
            <tr>
              <td class="ps-3">{{ 'g.language' | transloco }}:</td>
              <td>{{ popover.task.asrOperation.language }}</td>
            </tr>
            <tr>
              <td class="ps-3">{{ 'g.asr provider' | transloco }}:</td>
              <td>{{ popover.task.asrOperation.serviceProvider?.provider }}</td>
            </tr>
            @if (taskService.state.currentMode === 'annotation') {
              @if (popover.task.asrOperation.diarization?.enabled) {
                <tr>
                  <td class="ps-3">{{ 'modals.check options.options.diarization.name' | transloco }}:</td>
                  <td>Enabled</td>
                </tr>
                <tr>
                  <td class="ps-3">{{ 'modals.check options.options.number of speakers.name' | transloco }}:</td>
                  <td>{{ popover.task.asrOperation.diarization?.speakers }}</td>
                </tr>
              }
              <tr>
                <td class="ps-3">{{ 'modals.check options.options.word alignment language.name' | transloco }}:</td>
                <td>{{ popover.task.mausOperation.language }}</td>
              </tr>
            } @else if (taskService.state.currentMode === 'summarization') {
              <tr>
                <td class="ps-3">{{ 'modals.check options.options.number of words.name' | transloco }}:</td>
                <td>{{ popover.task.summarizationOperation.maxNumberOfWords }}</td>
              </tr>
              <tr>
                <td class="ps-3">{{ 'modals.check options.options.translation language.name' | transloco }}:</td>
                <td>{{ popover.task.translationOperation.language }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Audio information</div>
      <div class="card-body p-0">
        <tportal-file-info-table [fileinfo]="getAudioFileOfTask(popover.task)"></tportal-file-info-table>
      </div>
    </div>
  }
</tportal-popover>

<div
  #inner
  (dragover)="onDragOver($event)"
  (drop)="onDrop($event)"
  (contextmenu)="cancelContextMenu($event)"
  (mouseleave)="isDragging = false"
  (scroll)="onTableScroll()"
  (mousedown)="onTableMouseDown($event)"
  (mouseup)="onTableMouseUp()"
  class="inner"
>
  @if (taskList !== undefined && taskList.length === 0 && taskService.state.currentModeState.taskList!.entries.length === 0 && queue.length === 0) {
    <div class="tportal-placeholder">
      <h1 class="display-3" style="margin-top: 5%; margin-bottom: 20px">
        @if (taskService.state.currentMode === 'annotation') {
          {{ 'modes.annotation.name' | transloco }}
        } @else if (taskService.state.currentMode === 'summarization') {
          {{ 'modes.summarization and translation.name' | transloco }}
        }
      </h1>
      <p class="px-5" [innerHTML]="'quick start.introduction' | transloco"></p>
      @if (taskService.state.currentMode === 'annotation') {
        <p
          class="px-5"
          [innerHTML]="
            'quick start.modes.annotation'
              | transloco
                : {
                    Octra:
                      '<a href=\'https:\/\/clarin.phonetik.uni-muenchen.de/apps/octra/octra/login\' class=\'text-decoration-none\' target=\'_blank\'>Octra</a>',
                    EmuWebApp: '<a href=\'https:\/\/ips-lmu.github.io/EMU-webApp/\' target=\'_blank\' class=\'text-decoration-none\'>Emu-webApp</a>',
                  }
          "
        ></p>
      } @else if (taskService.state.currentMode === 'summarization') {
        <p
          class="px-5"
          [innerHTML]="
            'quick start.modes.summarization'
              | transloco
                : {
                    Octra:
                      '<a href=\'https:\/\/clarin.phonetik.uni-muenchen.de/apps/octra/octra/login\' class=\'text-decoration-none\' target=\'_blank\'>Octra</a>',
                    EmuWebApp: '<a href=\'https:\/\/ips-lmu.github.io/EMU-webApp/\' target=\'_blank\' class=\'text-decoration-none\'>Emu-webApp</a>',
                  }
          "
        ></p>
      }
      <ng-template [ngTemplateOutlet]="quickstartNumeration"></ng-template>
      <ng-template #quickstartNumeration>
        <div class="row quickstart px-3 pt-5">
          <div class="col-4">
            <div style="width: 80px; height: 80px; margin: 0 auto">
              <div
                class="rounded-circle"
                style="
                  background-color: cornflowerblue;
                  width: 80px;
                  height: 80px;
                  color: white;
                  text-align: center;
                  vertical-align: middle;
                  font-size: 2em;
                  display: table-cell;
                  margin: 0 auto;
                "
              >
                1.
              </div>
            </div>
            <h4>{{ 'buttons.add files' | transloco }}</h4>
            <p
              [innerHTML]="'quick start.add files.description' | transloco: { addFilesButton: '1. ' + ('buttons.add files' | transloco | uppercase) }"
            ></p>
          </div>
          <!-- /.col-lg-4 -->
          <div class="col-4">
            <div style="width: 80px; height: 80px; margin: 0 auto">
              <div
                class="rounded-circle"
                style="
                  background-color: cornflowerblue;
                  width: 80px;
                  height: 80px;
                  color: white;
                  text-align: center;
                  vertical-align: middle;
                  font-size: 2em;
                  display: table-cell;
                  margin: 0 auto;
                "
              >
                2.
              </div>
            </div>
            <h4>{{ 'buttons.check options' | transloco }}</h4>
            <p
              [innerHTML]="
                'quick start.check options.description' | transloco: { checkOptionsButton: '2. ' + ('buttons.check options' | transloco | uppercase) }
              "
            ></p>
          </div>
          <!-- /.col-lg-4 -->
          <div class="col-4">
            <div style="width: 80px; height: 80px; margin: 0 auto">
              <div
                class="rounded-circle"
                style="
                  background-color: cornflowerblue;
                  width: 80px;
                  height: 80px;
                  color: white;
                  text-align: center;
                  vertical-align: middle;
                  font-size: 2em;
                  display: table-cell;
                  margin: 0 auto;
                "
              >
                3.
              </div>
            </div>
            <h4>{{ 'buttons.start processing' | transloco }}</h4>
            <p
              [innerHTML]="
                'quick start.start processing.description'
                  | transloco: { startProcessingButton: '3. ' + ('buttons.start processing' | transloco | uppercase) }
              "
            ></p>
          </div>
          <!-- /.col-lg-4 -->
        </div>
      </ng-template>
    </div>
  }
  @if (taskList !== undefined && taskList.length > 0 && !storage.ready) {
    <div id="loading">
      <div class="spinner-border fs-1" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
  @if (storage.ready) {
    <!-- Big proceedings table -->
    <table
      class="table table-striped"
      [ngClass]="{
        'fixed-table-layout': !shortstyle,
      }"
    >
      <!-- TABLE HEADER -->
      <thead>
        <tr class="tableHeaderTop">
          <th (click)="onOpenAllRows()" style="width: 25px; padding-right: 0; text-align: center; cursor: pointer">
            @if (allDirOpened === 'opened') {
              <i class="bi bi-chevron-up"></i>
            }
            @if (allDirOpened === 'closed') {
              <i class="bi bi-chevron-down"></i>
            }
          </th>
          <th style="width: 20%">File</th>
          @for (operation of operations; track operation.id; let i = $index) {
            <ng-container style="text-align: center">
              <th
                (mousemove)="updateChanges()"
                style="padding-left: 3px; padding-right: 3px"
                [ngStyle]="{
                  width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                }"
              >
                <div style="position: relative">
                  <div style="display: block; position: relative; height: 25px; cursor: pointer">
                    <tportal-operation-arrow [first]="i === 0" [type]="'arrow'"></tportal-operation-arrow>
                    <div style="z-index: 10; width: 100%; text-align: center">
                      <ng-template #tipContent>{{ operation.description }}</ng-template>
                      <div
                        (click)="openArchiveDownload('column', operation, taskService.currentModeState!.selectedRows)"
                        [ngbTooltip]="tipContent"
                        [container]="'body'"
                        tooltipClass="operation-tooltip"
                        placement="bottom"
                        style="display: inline; padding: 0 3px"
                      >
                        @if (shortstyle) {
                          {{ operation.shortTitle }}
                        }
                        @if (!shortstyle) {
                          <span class="d-none d-xl-inline-block">{{ operation.title }}</span>
                          <span class="d-inline-block d-xl-none">{{ operation.shortTitle }}</span>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              </th>
            </ng-container>
          }
          <th [ngStyle]="{ width: !isClosed ? maxColumnWidths[5] + '%' : 'auto' }">
            <div style="position: relative" class="ng-tns-c118-4">
              <div style="display: block; position: relative; height: 25px; cursor: pointer" class="ng-tns-c118-4">
                <tportal-operation-arrow [first]="false" [type]="'circle'"></tportal-operation-arrow>
                <div style="z-index: 10; width: 100%; text-align: center" class="ng-tns-c118-4">
                  <div style="display: inline; padding: 0 3px" class="operation-tooltip" aria-describedby="tooltip-9">
                    @if (shortstyle) {
                      <span><i class="bi bi-cloud-download"></i></span>
                    }
                    @if (!shortstyle) {
                      <span class="d-none d-xl-inline-block">{{ 'g.export' | transloco }}</span>
                      <span class="d-inline-block d-xl-none"><i class="bi bi-cloud-download"></i></span>
                    }
                  </div>
                </div>
              </div>
            </div>
          </th>
        </tr>
        <tr class="subTableHeader">
          <th style="width: 15px; padding-right: 0; text-align: center"></th>
          <th style="width: 20%"></th>
          @for (operation of operations; track operation.id; let i = $index) {
            <ng-container style="text-align: center">
              @if (operation.name === 'OCTRA' || operation.name === 'ASR') {
                <th
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <input (click)="deactivateOperation(operation, i)" [checked]="operation.enabled" class="header-checkbox" type="checkbox" />
                </th>
              } @else if (operation.name === 'MAUS') {
                <th
                  colspan="2"
                  style="position: relative"
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <img src="assets/directory.png" style="height: 25px; left: 0; position: absolute" />
                  <input (click)="deactivateOperation(operation, i)" [checked]="operation.enabled" class="header-checkbox" type="checkbox" />
                  <img
                    src="assets/directory.png"
                    style="height: 25px; -webkit-transform: scaleX(-1); transform: scaleX(-1); right: 0; position: absolute"
                  />
                </th>
              } @else if (operation.name === 'Summarization') {
                <th
                  style="position: relative"
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <input (click)="deactivateOperation(operation, i)" [checked]="operation.enabled" class="header-checkbox" type="checkbox" />
                </th>
              } @else if (operation.name === 'Translation') {
                <th
                  style="position: relative"
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <input (click)="deactivateOperation(operation, i)" [checked]="operation.enabled" class="header-checkbox" type="checkbox" />
                </th>
              } @else if (i === 0) {
                <th></th>
              }
            </ng-container>
          }
          <th
            [ngStyle]="{
              width: !isClosed ? maxColumnWidths[5] + '%' : 'auto',
            }"
          ></th>
        </tr>
      </thead>
      <!-- TABLE BODY -->
      <tbody>
        <tportal-context-menu
          (optionselected)="onContextMenuOptionSelected($event)"
          [hid]="contextmenu.hidden"
          [ngStyle]="{
            'margin-top': contextmenu.y + 'px',
            'margin-left': contextmenu.x + 'px',
            display:
              contextmenu.hidden || (this.taskService.currentModeState !== undefined && this.taskService.currentModeState.selectedRows.length === 0)
                ? 'none'
                : 'initial',
          }"
          [selectedOperationType]="selectedOperation"
          [selectedTasks]="this.taskService.currentModeState!.selectedRows"
        >
        </tportal-context-menu>
        @if (taskList !== undefined) {
          @for (entry of taskList.entries; track entry.id; let i = $index) {
            <tr
              [entry]="entry"
              [rowSelected]="isEntrySelected(entry)"
              [toolSelectedOperation]="toolSelectedOperation"
              (contextmenu)="onContextMenu($event, row)"
              (click)="onContextBlur()"
              (scroll)="cancelScroll($event)"
              tportalProceedingsRow
              #row
            >
              <td
                #nameCol="colIcon"
                (appendingClick)="onPreviewClick($event)"
                (click)="onRowSelected(entry)"
                (deleteIconClick)="removeEntry($event, getTask(entry))"
                (infoMouseEnter)="onInfoMouseEnter($event, getTask(entry))"
                (infoMouseLeave)="onInfoMouseLeave($event, getTask(entry))"
                (infoMouseOver)="onInfoMouseOver($event, getTask(entry))"
                (mouseenter)="onNameMouseEnter($event, getTask(entry))"
                (mouseleave)="onNameMouseLeave($event, getTask(entry))"
                (mouseover)="onNameMouseOver($event, getTask(entry))"
                (tagClicked)="onTagClicked()"
                [dirOpened]="allDirOpened"
                [entry]="entry"
                [mouseOver]="getTask(entry) ? getTask(entry)!.mouseover : false"
                [shortStyle]="isClosed"
                tportalProcColIcon
              ></td>
              <!-- Task operations-->
              @if (entry.type === 'task') {
                @for (operation of getTask(entry)!.operations; track operation.id; let opIndex = $index) {
                  <td
                    (click)="onRowSelected(entry, operation)"
                    (mousedown)="onOperationClick($event, operation)"
                    #td
                    (operationMouseEnter)="onOperationMouseEnter($event, operation, td)"
                    (operationMouseLeave)="onOperationMouseLeave($event, operation)"
                    (operationMouseOver)="onOperationMouseOver($event, operation)"
                    [entry]="getTask(entry)"
                    [ngStyle]="{
                      width: !isClosed ? maxColumnWidths[opIndex] + '%' : 'auto',
                    }"
                    [operation]="operation"
                    tportalProcColOperation
                    [title]="'task ' + entry.id + ', ' + operation.lastRound?.lastResult?.online"
                  ></td>
                }
                <td class="export-col">
                  @if (isOneOperationFinished(entry) && getTask(entry) !== undefined) {
                    <button
                      class="btn btn-outline-success"
                      style="padding: 0 5px"
                      (click)="onExportButtonClick(entry, getTask(entry)!.operations[1])"
                    >
                      <i class="bi bi-cloud-download"></i>
                    </button>
                  }
                </td>
              }
              @if (entry.type === 'folder') {
                @for (operation of taskService.state.currentModeState.operations; track operation.id; let opIndex = $index) {
                  <td (click)="onRowSelected(entry)">
                    <div class="progress">
                      <div
                        [dir]="getTaskDirectory(entry)"
                        [opIndex]="opIndex"
                        tportalDirProgress
                        aria-valuemax="100"
                        aria-valuemin="0"
                        class="progress-bar"
                        role="progressbar"
                      ></div>
                    </div>
                  </td>
                }
                <td class="export-col">
                  @if (isOneOperationFinished(entry)) {
                    <button class="btn btn-outline-success" style="padding: 0 5px" (click)="onExportButtonClick(entry)">
                      <i class="bi bi-cloud-download"></i>
                    </button>
                  }
                </td>
              }
            </tr>
            @if (entry.type === 'folder') {
              <!-- folder row -->
              @for (dirEntry of getTaskDirEntries(entry); track dirEntry.id) {
                <tr
                  [@fadeToggleRow]="nameCol.dirOpened"
                  [entry]="dirEntry"
                  [rowSelected]="isEntrySelected(dirEntry)"
                  [toolSelectedOperation]="toolSelectedOperation"
                  tportalProceedingsRow
                >
                  <td
                    (click)="onRowSelected(dirEntry)"
                    (deleteIconClick)="removeEntry($event, dirEntry)"
                    (infoMouseEnter)="onInfoMouseEnter($event, dirEntry)"
                    (infoMouseLeave)="onInfoMouseLeave($event, dirEntry)"
                    (infoMouseOver)="onInfoMouseOver($event, dirEntry)"
                    (mouseenter)="onNameMouseEnter($event, dirEntry)"
                    (mouseleave)="onNameMouseLeave($event, dirEntry)"
                    (mouseover)="onNameMouseOver($event, dirEntry)"
                    [entry]="dirEntry"
                    [mouseOver]="dirEntry.mouseover"
                    [shortStyle]="shortstyle"
                    tportalProcColIcon
                  ></td>
                  @for (operation of dirEntry.operations; track operation.id) {
                    <td
                      (click)="onRowSelected(dirEntry, operation)"
                      (mousedown)="onOperationClick($event, operation)"
                      #td
                      (operationMouseEnter)="onOperationMouseEnter($event, operation, td)"
                      (operationMouseLeave)="onOperationMouseLeave($event, operation)"
                      (operationMouseOver)="onOperationMouseOver($event, operation)"
                      [entry]="dirEntry"
                      [operation]="operation"
                      tportalProcColOperation
                    ></td>
                  }
                  <td class="export-col">
                    @if (isOneOperationFinished(dirEntry)) {
                      <button class="btn btn-outline-success" style="padding: 0 5px" (click)="onExportButtonClick(dirEntry, undefined)">
                        <i class="bi bi-cloud-download"></i>
                      </button>
                    }
                  </td>
                </tr>
              }
            }
          }
        }
        <!-- Queue rows -->
        @for (entry of queue; track entry.id; let i = $index) {
          @if (entry.file !== undefined) {
            <tr style="cursor: pointer">
              @if (getDirEntriesFromItem(entry).length === 0) {
                <td [attr.colspan]="taskService.state.currentModeState.operations.length + 3" [ngClass]="{ shorten: shortstyle }">
                  <i aria-hidden="true" class="bi bi-database op-50"> </i>
                  <span class="op-50" title="{{ getFileInfo(entry)?.fullname }}">
                    {{ getFileInfo(entry)?.fullname }}
                    <i class="bi bi-gear spin"></i>
                  </span>
                </td>
              }
              @if (getDirEntriesFromItem(entry).length > 0) {
                <td [attr.colspan]="taskService.state.currentModeState.operations.length + 3">
                  <i aria-hidden="true" class="bi bi-folder2-open blue op-50"></i>
                  <span class="op-50" title="{{ entry.file.name }}">{{ entry.file.name }} <i class="bi bi-gear-fill spin"></i> </span>
                </td>
              }
            </tr>
          }
          @for (dirEntry of getDirEntriesFromItem(entry); track dirEntry.fullname) {
            <tr>
              <td>
                <div class="d-flex">
                  <i aria-hidden="true" class="bi bi-database op-50 me-1"></i>
                  <span class="op-50 me-1">{{ dirEntry.fullname }}</span>
                  <i class="bi bi-gear-fill spin"></i>
                </div>
              </td>
              <td [attr.colspan]="taskService.state.currentModeState.operations.length + 2"></td>
            </tr>
          }
        }
      </tbody>
    </table>
  }
</div>
