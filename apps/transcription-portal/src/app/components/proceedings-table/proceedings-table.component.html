<tportal-popover
  #popoverRef
  (mouseenter)="popover.mouseIn = true"
  (mousemove)="popover.mouseIn = true"
  (mouseleave)="togglePopover(false)"
  [@fadeToggleRow]="popover.state"
  [borderColor]="getPopoverColor(popover.operation!)"
  [height]="popover.height"
  [ngStyle]="{
    width: popover.width + 'px',
    height: popover.height + 'px',
    'margin-top': popover.y + 'px',
    'margin-left': popover.x + 4 + 'px',
  }"
  [pointer]="popover.pointer"
  [width]="popover.width"
>
  @if (popover.operation !== undefined && popover.lastOperationRound !== undefined) {
    @if (
      popover.lastOperationRound.time !== undefined &&
      popover.lastOperationRound.time.start !== undefined &&
      popover.lastOperationRound.time.start > 0
    ) {
      @if (
        popover.lastOperationRound.status === 'FINISHED' && !popover.lastOperationRoundResult?.content && !popover.lastOperationRoundResult?.online
      ) {
        <p style="color: red">{{ 'popovers.results.last result unavailable' | transloco }}</p>
      }
      <div class="row g-0">
        <div class="col" style="font-size: 0.85rem">
          <i class="bi bi-clock" style="color: cornflowerblue"></i
          ><span> {{ popover.lastOperationRound.time.start | luxonFormat: 'DATETIME_SHORT' }}</span>
        </div>
        <div class="col text-end" style="font-size: 0.85rem">
          <i class="bi bi-hourglass" style="color: cornflowerblue"></i
          ><span> {{ calculateDuration(popover.lastOperationRound.time, popover.operation) | time: 'true' }}</span>
        </div>
      </div>
    }
    @if (popover.lastOperationRound.status === 'PROCESSING' && popover.operation.serviceProviderName !== undefined) {
      <div class="service-preview">
        <div class="provided-by">{{ 'p.service provided by' | transloco }}</div>
        <a
          [href]="getServerProvider(popover.operation.serviceProviderName)?.homepageURL"
          style="display: block; vertical-align: middle"
          target="_blank"
        >
          <img
            [src]="getServerProvider(popover.operation.serviceProviderName)?.logoURL"
            alt="EML Logo"
            class="service-logo"
            style="border: 1px solid lightgray"
          />
        </a>
        <div class="service-terms">
          <a [href]="getServerProvider(popover.operation.serviceProviderName)?.termsURL" target="_blank"
            ><i class="bi bi-journal-text"></i> {{ 'p.service terms' | transloco }}</a
          ><br />
          <a [href]="getServerProvider(popover.operation.serviceProviderName)?.homepageURL" target="_blank"
            ><i class="bi bi-globe"></i> {{ 'g.homepage' | transloco }}</a
          ><br />
        </div>
        <i (click)="onReportIconClick(popover.operation)" class="bi bi-exclamation-circle report-issue"></i>
      </div>
      <div class="service-remarks">
        <ul>
          <li>{{ 'popovers.results.service remarks.processing time' | transloco }}</li>
          <li>{{ 'popovers.results.service remarks.about the result' | transloco }}</li>
          <li>{{ getServerProvider(popover.operation.serviceProviderName)?.dataStoragePolicy }}</li>
        </ul>
      </div>
      <div class="clearfix"></div>
    } @else if (popover.operation.rounds.length > 0) {
      <div style="overflow: hidden">
        <tportal-results-table
          #resultsTableComponent
          [visible]="popover.state === 'opened'"
          (previewClick)="onPreviewClick($event)"
          [operation]="popover.operation"
          [defaultOperations]="operations"
          [task]="popover.task"
        ></tportal-results-table>
      </div>
    }
    @if ((popover.lastOperationRound.parsedProtocol ?? []).length > 0) {
      <div class="mt-3 border" id="output-area">
        <div style="width: 100%; text-align: right; padding: 0; margin-bottom: 0">
          <button
            (click)="copyProtocolToClipboard(popover.lastOperationRound.protocol)"
            class="btn btn-sm btn-outline-info"
            style="font-size: 11px; cursor: pointer; margin-bottom: 0"
          >
            <i class="bi bi-clipboard"></i> Copy to clipboard
          </button>
        </div>
        @if (getLastOperationRound(popover.operation!)?.parsedProtocol && getLastOperationRound(popover.operation)!.parsedProtocol!.length > 0) {
          <div class="mt-3 border" id="output-area">
            <div class="row g-0 py-1 px-2 justify-items-center align-items-center" style="background-color: #1b4685">
              <div class="col-sm text-light" style="font-size: 0.9rem">{{ 'g.protocol' | transloco }}</div>
              <div class="col-auto">
                <button
                  (click)="copyProtocolToClipboard(popover.operation.protocol)"
                  class="btn btn-sm btn-outline-light"
                  style="font-size: 11px; cursor: pointer; margin-bottom: 0"
                >
                  <i class="bi bi-clipboard"></i> {{ 'p.copy to clipboard' | transloco }}
                </button>
              </div>
            </div>
            <div class="list-group" id="op-protocol-list">
              @for (item of getLastOperationRound(popover.operation)!.parsedProtocol!; track item) {
                <div
                  class="list-group-item p-1 rounded-top-0 rounded-bottom-0"
                  [ngClass]="{
                    'list-group-item-warning': item.type === 'WARNING',
                    'list-group-item-danger': item.type === 'ERROR',
                  }"
                >
                  <div class="row g-1">
                    <div class="col-auto">
                      @if (item.type === 'ERROR') {
                        <i class="bi bi-exclamation-circle" style="color: red"></i>
                      } @else {
                        <i class="bi bi-exclamation-triangle" style="color: orange"></i>
                      }
                    </div>
                    <div class="col text-break">
                      {{ item.message }}
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  }
  @if (popover.operation === undefined && popover.task) {
    <div class="card mb-3">
      <div class="card-header">Task Options</div>
      <div class="card-body p-0">
        <table class="table table-striped table-sm options-info-table p-3 m-0">
          <tbody class="">
            <tr>
              <td class="ps-3">{{ 'g.language' | transloco }}:</td>
              <td>{{ popover.task.operations[1].options.language }}</td>
            </tr>
            <tr>
              <td class="ps-3">{{ 'g.asr provider' | transloco }}:</td>
              <td>{{ popover.task.operations[1].options.serviceProvider?.provider }}</td>
            </tr>
            @if (modeStoreService.currentMode === 'annotation') {
              @if (popover.task.operations[1].options.diarization?.enabled) {
                <tr>
                  <td class="ps-3">{{ 'modals.check options.options.diarization.name' | transloco }}:</td>
                  <td>Enabled</td>
                </tr>
                <tr>
                  <td class="ps-3">{{ 'modals.check options.options.number of speakers.name' | transloco }}:</td>
                  <td>{{ popover.task.operations[1].options.diarization?.speakers }}</td>
                </tr>
              }
              <tr>
                <td class="ps-3">{{ 'modals.check options.options.word alignment language.name' | transloco }}:</td>
                <td><!-- TODO add {{ popover.task.mausOperation.language }}--></td>
              </tr>
            } @else if (modeStoreService.currentMode === 'summarization') {
              <tr>
                <td class="ps-3">{{ 'modals.check options.options.number of words.name' | transloco }}:</td>
                <td><!-- TODO add {{ popover.task.summarizationOperation.maxNumberOfWords }}--></td>
              </tr>
              <tr>
                <td class="ps-3">{{ 'modals.check options.options.translation language.name' | transloco }}:</td>
                <td><!-- TODO add {{ popover.task.translationOperation.language }}--></td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
  @if (popover.lastOperationRound === undefined && popover.task) {
    <div class="card">
      <div class="card-header">Audio information</div>
      <div class="card-body p-0">
        <tportal-file-info-table [fileinfo]="popover.task.files[0]"></tportal-file-info-table>
      </div>
    </div>
  }
</tportal-popover>

<div
  #inner
  (dragover)="onDragOver($event)"
  (drop)="onDrop($event)"
  (contextmenu)="cancelContextMenu($event)"
  (click)="contextmenu.hidden = true"
  (mouseleave)="isDragging = false"
  (scroll)="onTableScroll()"
  (mousedown)="onTableMouseDown($event)"
  (mouseup)="onTableMouseUp()"
  class="inner"
  style="border: 1px solid lightgray"
>
  @if (
    entries !== undefined &&
    entries !== null &&
    entries.length === 0 &&
    entries.length === 0 &&
    (queue === undefined || queue === null || queue.length === 0)
  ) {
    <div class="tportal-placeholder">
      <h1 class="display-3" style="margin-top: 5%; margin-bottom: 20px">
        @if (currentMode === 'annotation') {
          {{ 'modes.annotation.name' | transloco }}
        } @else if (currentMode === 'summarization') {
          {{ 'modes.summarization and translation.name' | transloco }}
        }
      </h1>
      <p class="px-5" [innerHTML]="'quick start.introduction' | transloco"></p>
      @if (modeStoreService.currentMode === 'annotation') {
        <p
          class="px-5"
          [innerHTML]="
            'quick start.modes.annotation'
              | transloco
                : {
                    Octra:
                      '<a href=\'https:\/\/clarin.phonetik.uni-muenchen.de/apps/octra/octra/login\' class=\'text-decoration-none\' target=\'_blank\'>Octra</a>',
                    EmuWebApp: '<a href=\'https:\/\/ips-lmu.github.io/EMU-webApp/\' target=\'_blank\' class=\'text-decoration-none\'>Emu-webApp</a>',
                  }
          "
        ></p>
      } @else if (modeStoreService.currentMode === 'summarization') {
        <p
          class="px-5"
          [innerHTML]="
            'quick start.modes.summarization'
              | transloco
                : {
                    Octra:
                      '<a href=\'https:\/\/clarin.phonetik.uni-muenchen.de/apps/octra/octra/login\' class=\'text-decoration-none\' target=\'_blank\'>Octra</a>',
                    EmuWebApp: '<a href=\'https:\/\/ips-lmu.github.io/EMU-webApp/\' target=\'_blank\' class=\'text-decoration-none\'>Emu-webApp</a>',
                  }
          "
        ></p>
      }
      <ng-template [ngTemplateOutlet]="quickstartNumeration"></ng-template>
      <ng-template #quickstartNumeration>
        <div class="row quickstart px-3 pt-5">
          <div class="col-4">
            <div style="width: 80px; height: 80px; margin: 0 auto">
              <div
                class="rounded-circle"
                style="
                  background-color: cornflowerblue;
                  width: 80px;
                  height: 80px;
                  color: white;
                  text-align: center;
                  vertical-align: middle;
                  font-size: 2em;
                  display: table-cell;
                  margin: 0 auto;
                "
              >
                1.
              </div>
            </div>
            <h4>{{ 'buttons.add files' | transloco }}</h4>
            <p
              [innerHTML]="'quick start.add files.description' | transloco: { addFilesButton: '1. ' + ('buttons.add files' | transloco | uppercase) }"
            ></p>
          </div>
          <!-- /.col-lg-4 -->
          <div class="col-4">
            <div style="width: 80px; height: 80px; margin: 0 auto">
              <div
                class="rounded-circle"
                style="
                  background-color: cornflowerblue;
                  width: 80px;
                  height: 80px;
                  color: white;
                  text-align: center;
                  vertical-align: middle;
                  font-size: 2em;
                  display: table-cell;
                  margin: 0 auto;
                "
              >
                2.
              </div>
            </div>
            <h4>{{ 'buttons.check options' | transloco }}</h4>
            <p
              [innerHTML]="
                'quick start.check options.description' | transloco: { checkOptionsButton: '2. ' + ('buttons.check options' | transloco | uppercase) }
              "
            ></p>
          </div>
          <!-- /.col-lg-4 -->
          <div class="col-4">
            <div style="width: 80px; height: 80px; margin: 0 auto">
              <div
                class="rounded-circle"
                style="
                  background-color: cornflowerblue;
                  width: 80px;
                  height: 80px;
                  color: white;
                  text-align: center;
                  vertical-align: middle;
                  font-size: 2em;
                  display: table-cell;
                  margin: 0 auto;
                "
              >
                3.
              </div>
            </div>
            <h4>{{ 'buttons.start processing' | transloco }}</h4>
            <p
              [innerHTML]="
                'quick start.start processing.description'
                  | transloco: { startProcessingButton: '3. ' + ('buttons.start processing' | transloco | uppercase) }
              "
            ></p>
          </div>
          <!-- /.col-lg-4 -->
        </div>
      </ng-template>
    </div>
  }
  @if (operations !== undefined && operations !== null) {
    <!-- Big proceedings table -->
    <table
      class="table table-striped"
      [ngClass]="{
        'fixed-table-layout': !shortstyle,
      }"
    >
      <!-- TABLE HEADER -->
      <thead>
        <tr class="tableHeaderTop">
          <th (click)="onOpenAllRows()" style="width: 25px; padding-right: 0; text-align: center; cursor: pointer">
            @if (allDirOpened === 'opened') {
              <i class="bi bi-chevron-up"></i>
            }
            @if (allDirOpened === 'closed') {
              <i class="bi bi-chevron-down"></i>
            }
          </th>
          <th style="width: 20%">File</th>
          @for (operation of operations; track operation.factory.name; let i = $index) {
            <ng-container style="text-align: center">
              <th
                (mousemove)="updateChanges()"
                style="padding-left: 3px; padding-right: 3px"
                [ngStyle]="{
                  width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                }"
              >
                <div style="position: relative">
                  <div
                    style="display: block; position: relative; height: 25px; cursor: pointer"
                    (click)="openArchiveDownload('column', operation.factory)"
                  >
                    <tportal-operation-arrow [first]="i === 0" [type]="'arrow'"></tportal-operation-arrow>
                    <div style="z-index: 10; width: 100%; text-align: center">
                      <ng-template #tipContent>{{ operation.factory.description }}</ng-template>
                      <div
                        [ngbTooltip]="tipContent"
                        [container]="'body'"
                        tooltipClass="operation-tooltip"
                        placement="bottom"
                        style="display: inline; padding: 0 3px"
                      >
                        @if (shortstyle) {
                          {{ operation.factory.shortTitle }}
                        }
                        @if (!shortstyle) {
                          <span class="d-none d-xl-inline-block">{{ operation.factory.title }}</span>
                          <span class="d-inline-block d-xl-none">{{ operation.factory.shortTitle }}</span>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              </th>
            </ng-container>
          }
          <th [ngStyle]="{ width: !isClosed ? maxColumnWidths[5] + '%' : 'auto' }">
            <div style="position: relative" class="ng-tns-c118-4">
              <div style="display: block; position: relative; height: 25px; cursor: pointer" class="ng-tns-c118-4">
                <tportal-operation-arrow [first]="false" [type]="'circle'"></tportal-operation-arrow>
                <div style="z-index: 10; width: 100%; text-align: center" class="ng-tns-c118-4">
                  <div style="display: inline; padding: 0 3px" class="operation-tooltip" aria-describedby="tooltip-9">
                    @if (shortstyle) {
                      <span><i class="bi bi-cloud-download"></i></span>
                    }
                    @if (!shortstyle) {
                      <span class="d-none d-xl-inline-block">{{ 'g.export' | transloco }}</span>
                      <span class="d-inline-block d-xl-none"><i class="bi bi-cloud-download"></i></span>
                    }
                  </div>
                </div>
              </div>
            </div>
          </th>
        </tr>
        <tr class="subTableHeader">
          <th style="width: 15px; padding-right: 0; text-align: center"></th>
          <th style="width: 20%"></th>
          @for (operation of operations; track operation.factory.name; let i = $index) {
            <ng-container style="text-align: center">
              @if (operation.factory.name === 'OCTRA' || operation.factory.name === 'ASR') {
                <th
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <input
                    class="header-checkbox"
                    type="checkbox"
                    [checked]="operation.enabled"
                    (change)="modeStoreService.setDefaultOperationEnabled(operation.factory.name, checkb.checked)"
                    #checkb
                  />
                </th>
              } @else if (operation.factory.name === 'MAUS') {
                <th
                  colspan="2"
                  style="position: relative"
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <img src="assets/directory.png" style="height: 25px; left: 0; position: absolute" />
                  <input
                    class="header-checkbox"
                    type="checkbox"
                    [checked]="operation.enabled"
                    (change)="modeStoreService.setDefaultOperationEnabled(operation.factory.name, checkb.checked)"
                    #checkb
                  />
                  <img
                    src="assets/directory.png"
                    style="height: 25px; -webkit-transform: scaleX(-1); transform: scaleX(-1); right: 0; position: absolute"
                  />
                </th>
              } @else if (operation.factory.name === 'Summarization') {
                <th
                  style="position: relative"
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <input
                    class="header-checkbox"
                    type="checkbox"
                    [checked]="operation.enabled"
                    (change)="modeStoreService.setDefaultOperationEnabled(operation.factory.name, checkb.checked)"
                    #checkb
                  />
                </th>
              } @else if (operation.factory.name === 'Translation') {
                <th
                  style="position: relative"
                  [ngStyle]="{
                    width: !isClosed ? maxColumnWidths[i] + '%' : 'auto',
                  }"
                >
                  <input
                    class="header-checkbox"
                    type="checkbox"
                    [checked]="operation.enabled"
                    (change)="modeStoreService.setDefaultOperationEnabled(operation.factory.name, checkb.checked)"
                    #checkb
                  />
                </th>
              } @else if (i === 0) {
                <th></th>
              }
            </ng-container>
          }
          <th
            [ngStyle]="{
              width: !isClosed ? maxColumnWidths[5] + '%' : 'auto',
            }"
          ></th>
        </tr>
      </thead>
      <!-- TABLE BODY -->
      <tportal-context-menu
        #contextmenuRef
        (optionselected)="onContextMenuOptionSelected($event)"
        [hid]="contextmenu.hidden"
        [ngStyle]="{
          'margin-top': contextmenu.y + 'px',
          'margin-left': contextmenu.x + 'px',
          visibility: contextmenu.hidden || ((modeStoreService.currentModeEntries$ | async) ?? []).length === 0 ? 'hidden' : 'initial',
        }"
        [selectedOperationType]="selectedOperation"
        [selectedTasks]="modeStoreService.currentModeEntries$ | async"
      >
      </tportal-context-menu>
      <tbody>
        <!-- ready tasks and directories -->
        @for (entry of entries; track entry.id; let entryIndex = $index) {
          <ng-container
            [ngTemplateOutlet]="taskOrDirRow"
            [ngTemplateOutletContext]="{
              entry,
              entryIndex,
              dirID: entry.type === 'folder' ? entry.id : undefined,
              fade: 'opened',
              contextmenuRef,
            }"
          ></ng-container>

          @if (entry.type === 'folder') {
            <!-- folder row -->
            @for (dirEntry of getTaskDirEntries(entry); track dirEntry.id; let entryIndex = $index) {
              <ng-container
                [ngTemplateOutlet]="taskOrDirRow"
                [ngTemplateOutletContext]="{
                  dirID: entry.id,
                  entry: dirEntry,
                  entryIndex,
                  fade: entry.opened === true ? 'opened' : 'closed',
                  contextmenuRef,
                }"
              ></ng-container>
            }
          }
        }

        <!-- Queue rows -->
        @for (entry of queue; track entry.id; let i = $index) {
          @if (entry.infoItem !== undefined) {
            <tr style="cursor: pointer">
              @if (getDirEntriesFromItem(entry).length === 0) {
                <td [attr.colspan]="operations.length + 3" [ngClass]="{ shorten: shortstyle }">
                  <i aria-hidden="true" class="bi bi-database op-50"> </i>
                  <span class="op-50" title="{{ entry.infoItem.name }}">
                    {{ entry.infoItem.name }}
                    <i class="bi bi-gear spin"></i>
                  </span>
                </td>
              }
              @if (getDirEntriesFromItem(entry).length > 0) {
                <td [attr.colspan]="operations.length + 3">
                  <i aria-hidden="true" class="bi bi-folder2-open blue op-50"></i>
                  <span class="op-50" title="{{ entry.infoItem.name }}">{{ entry.infoItem.name }} <i class="bi bi-gear-fill spin"></i> </span>
                </td>
              }
            </tr>
          }
          @for (dirEntry of getDirEntriesFromItem(entry); track dirEntry.name) {
            <tr>
              <td>
                <div class="d-flex">
                  <i aria-hidden="true" class="bi bi-database op-50 me-1"></i>
                  <span class="op-50 me-1">{{ dirEntry.name }}</span>
                  <i class="bi bi-gear-fill spin"></i>
                </div>
              </td>
              <td [attr.colspan]="operations.length + 2"></td>
            </tr>
          }
        }
      </tbody>
    </table>
  }
</div>


<ng-template
  #taskOrDirRow
  let-dirOpened="dirOpened"
  let-dirID="dirID"
  let-entry="entry"
  let-entryIndex="entryIndex"
  let-fade="fade"
  let-contextmenuRef="contextmenuRef"
>
  <tr
    [@fadeToggleRow]="fade"
    [entry]="entry"
    [rowSelected]="entry.selected"
    [toolSelectedOperation]="modeStoreService.openedToolOperation$ | async"
    (contextmenu)="onContextMenu($event, row, contextmenuRef)"
    (click)="onContextBlur()"
    (scroll)="cancelScroll($event)"
    (mouseenter)="nameCol.mouseOver = true"
    (mouseleave)="nameCol.mouseOver = false"
    (blur)="nameCol.mouseOver = false"
    tportalProceedingsRow
    #row
  >
    <td
      (appendingClick)="onPreviewClick($event)"
      (click)="onRowSelected(entry)"
      (deleteIconClick)="removeEntry($event, entry)"
      (infoMouseEnter)="onInfoMouseEnter($event, getTask(entry))"
      (infoMouseLeave)="onInfoMouseLeave($event, getTask(entry))"
      (infoMouseOver)="onInfoMouseOver($event, getTask(entry))"
      (tagClicked)="onTagClicked(dirID)"
      [entry]="entry"
      [shortStyle]="isClosed"
      tportalProcColIcon
      #nameCol="colIcon"
    ></td>
    @if (getTask(entry) !== undefined && entry.type === 'task') {
      @for (operation of entry.operations; track operation.id; let i = $index) {
        <td tportalProceedingsTableTd [storeTaskOperation]="operation" #td style="text-align: center" (mouseenter)="onOperationTDMouseEnter(entry)">
          <tportal-proceedings-table-operation-selector
            (mousedown)="onOperationClick($event, operation, i, entry)"
            (mouseenter)="onOperationMouseEnter($event, entry, operation, td)"
            (mouseleave)="onOperationMouseLeave($event, operation)"
            (mouseover)="onOperationMouseOver($event, entry, operation, i)"
            [storeTaskOperation]="operation"
            [factory]="operations![i].factory"
          ></tportal-proceedings-table-operation-selector>
        </td>
      }
    } @else {
      @for (operation of operations; track operation.factory.name; let opIndex = $index) {
        <td>
          <div class="progress">
            <div
              [dir]="getTaskDirectory(entry)"
              [opIndex]="opIndex"
              tportalDirProgress
              aria-valuemax="100"
              aria-valuemin="0"
              class="progress-bar"
              role="progressbar"
            ></div>
          </div>
        </td>
      }
    }
    <td class="export-col">
      @if (isOneOperationFinished(entry)) {
        <button class="btn btn-outline-success" style="padding: 0 5px" (click)="onExportButtonClick(entry, entryIndex)">
          <i class="bi bi-cloud-download"></i>
        </button>
      }
    </td>
  </tr>
</ng-template>
