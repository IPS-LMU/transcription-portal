<tportal-alert></tportal-alert>
<div (dragover)="onMissedDrop($event)" (drop)="onMissedDrop($event)" [hidden]="(appStoreService.appInitialized$ | async) === false" id="app">
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container justify-content-center" style="width: 100%; margin: 0; display: contents">
      <ul class="nav navbar-nav flex-fill w-100 flex-nowrap justify-items-center align-middle">
        <li class="nav-item active">
          <a class="nav-link" href="#" [ngbPopover]="versionPopover" popoverClass="version-popover"
            ><span class="logo"><img src="assets/TPortal-Logo_only.svg" style="height: 40px; margin-top: -10px" /> TranscriptionPortal</span>
            @if (isdevelopment) {
              <span style="color: red"> Beta </span>
            }
            <button
              (click)="isCollapsed = !isCollapsed"
              class="navbar-toggler position-absolute me-2"
              style="right: 0"
              data-target=".dual-collapse2"
              data-toggle="collapse"
              type="button"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
          </a>
          <ng-template #versionPopover>
            <div id="build-information">
              <div>
                <div class="fw-bold">Version:</div>
                <div>
                  {{ AppInfo.BUILD.version }}
                </div>
              </div>
              <div>
                <div class="fw-bold">Last updated:</div>
                <div>
                  {{ AppInfo.BUILD.timestamp | date: 'dd.MM.yyyy H:mm z' }}
                </div>
              </div>
              <div>
                <div class="fw-bold">Hash:</div>
                <div style="font-size: 0.7rem">
                  {{ AppInfo.BUILD.hash }}
                </div>
              </div>
            </div>
          </ng-template>
        </li>
      </ul>
      <div [ngbCollapse]="!isCollapsed" class="navbar-collapse collapse w-100 order-1 order-md-0 dual-collapse2">
        <ul class="nav navbar-nav flex-fill justify-content-center state-icons" style="min-width: 300px">
          <li class="nav-item">
            <div [ngbTooltip]="queuedTipp" class="totalState" tooltipClass="state-tooltip" placement="bottom">
              <div class="number">
                {{ (modeStoreService.overallStatistics$ | async)?.queued }}
              </div>
              <i class="bi bi-database-fill" style="color: gray"></i>
              <ng-template #queuedTipp
                >{{ (modeStoreService.overallStatistics$ | async)?.queued }} audio files are waiting for verification.
              </ng-template>
            </div>
            <div [ngbTooltip]="waitingTipp" class="totalState" tooltipClass="state-tooltip" placement="bottom">
              <div class="number">
                {{ (modeStoreService.overallStatistics$ | async)?.waiting }}
              </div>
              <i class="bi bi-clock-fill" style="color: dodgerblue"></i>
              <ng-template #waitingTipp>{{ (modeStoreService.overallStatistics$ | async)?.waiting }} tasks are waiting for processing. </ng-template>
            </div>
            <div [ngbTooltip]="runningTipp" class="totalState" tooltipClass="state-tooltip" placement="bottom">
              <div class="number">
                {{ (modeStoreService.overallStatistics$ | async)?.running }}
              </div>
              <i
                [ngClass]="{
                  spin: (modeStoreService.overallStatistics$ | async)!.running > 0,
                }"
                class="bi bi-gear-fill"
                style="color: orange"
              ></i>
              <ng-template #runningTipp>{{ (modeStoreService.overallStatistics$ | async)?.running }} tasks are running. </ng-template>
            </div>
            <div [ngbTooltip]="finishedTipp" class="totalState" tooltipClass="state-tooltip" placement="bottom">
              <div class="number">
                {{ (modeStoreService.overallStatistics$ | async)?.finished }}
              </div>
              <i class="bi bi-check-lg" style="color: forestgreen; font-weight: bold"></i>
              <ng-template #finishedTipp>{{ (modeStoreService.overallStatistics$ | async)?.finished }} tasks are finished. </ng-template>
            </div>
            <div [ngbTooltip]="errorsTipp" class="totalState" tooltipClass="state-tooltip" placement="bottom">
              <div class="number">
                {{ (modeStoreService.overallStatistics$ | async)?.errors }}
              </div>
              <i class="bi bi-x-lg" style="color: red; font-weight: 600"></i>
              <ng-template #errorsTipp
                >{{ (modeStoreService.overallStatistics$ | async)?.errors }} tasks failed. For further details please hover over the red "X" icon in a
                column.
              </ng-template>
            </div>
          </li>
        </ul>
      </div>
      <div [ngbCollapse]="!isCollapsed" class="navbar-collapse collapse w-100 order-1 order-md-0 dual-collapse2">
        <ul class="nav navbar-nav flex-fill w-100 justify-content-end right-icons">
          <li class="nav-item active">
            <a
              style="text-align: left; vertical-align: middle; cursor: pointer; text-decoration: none"
              (click)="openAboutModal()"
              ngbPopover="About"
              placement="bottom-right"
              triggers="mouseenter:mouseleave"
              ><i class="bi bi-info-circle" style="color: purple"></i>
              <span class="d-lg-none d-xl-inline-block ms-1" style="color: black">About</span></a
            >
          </li>
          <li class="nav-item active">
            <a
              href="https://clarin.phonetik.uni-muenchen.de/apps/TranscriptionPortal/contents/v1.0.0/help.html"
              style="text-align: left; vertical-align: middle; margin-top: 20px; cursor: pointer; text-decoration: none"
              target="_blank"
              ngbPopover="Help"
              placement="bottom-right"
              triggers="mouseenter:mouseleave"
              ><i class="bi bi-question-circle" style="color: cornflowerblue"></i>
              <span class="d-lg-none d-xl-inline-block ms-1" style="color: black">Help</span></a
            >
          </li>
          @if (settingsService.feedbackEnabled) {
            <li (click)="modalService.openFeedbackModal()" class="nav-item active">
              <a ngbPopover="Feedback" placement="bottom-right" triggers="mouseenter:mouseleave" class="text-decoration-none">
                <i
                  class="bi bi-exclamation-circle pointer"
                  [ngClass]="{
                    yellow: !bugService.hasErrors,
                    red: bugService.hasErrors,
                  }"
                ></i
                ><span style="cursor: pointer"> <span class="d-lg-none d-xl-inline-block ms-1" style="color: black">Feedback</span></span>
              </a>
            </li>
          }
          <li class="nav-item active" style="cursor: pointer">
            <span
              (click)="openStatisticsModal()"
              style="text-align: left; vertical-align: middle; margin-top: 20px; cursor: pointer"
              ngbPopover="Statistics"
              placement="bottom-right"
              triggers="mouseenter:mouseleave"
              ><i class="bi bi-bar-chart-line" style="color: #ff6a00"></i>
              <span class="d-lg-none d-xl-inline-block ms-1" style="color: black">Statistics</span></span
            >
          </li>
          <li class="nav-item active">
            <a
              class="pointer"
              (click)="notification.permissionGranted = !notification.permissionGranted"
              ngbPopover="Notifications"
              placement="bottom-right"
              triggers="mouseenter:mouseleave"
              style="color: black; text-decoration: none"
            >
              <i
                aria-hidden="true"
                [ngClass]="{
                  'bi-bell-slash': !notification.permissionGranted,
                  'bi-bell': notification.permissionGranted,
                }"
                class="bi"
                style="cursor: pointer"
              ></i
              ><span class="d-lg-none d-xl-inline-block ms-1">Notifications</span>
            </a>
          </li>
          <li class="nav-item active">
            <div ngbDropdown class="d-inline-block" [ngbCollapse]="settingsCollapsed" (openChange)="onSettingsDropdownChange($event)">
              <div
                class="pointer"
                style="color: dimgray"
                ngbDropdownToggle
                ngbPopover="Settings"
                placement="bottom-right"
                triggers="mouseenter:mouseleave"
              >
                <i class="bi bi-gear-wide-connected" id="dropdownBasic2" style="cursor: pointer"></i
                ><span class="d-lg-none d-xl-inline-block ms-1">Settings</span>
              </div>
              <div ngbDropdownMenu aria-labelledby="dropdownBasic2" (mouseleave)="accessCodeInputFieldType = 'password'" id="settings-dropdown">
                <div class="list-group">
                  <div class="list-group-item border-0">
                    <div class="divider-text"><span class="text-secondary">ASR</span></div>
                  </div>
                  <div class="list-group-item border-0 d-flex flex-column flex-auto">
                    <div style="font-size: 0.9em"><i class="bi bi-key"></i> Access Code (for Google ASR only):</div>
                    <div class="input-group" id="accessCodeGroup">
                      <form class="d-flex flex-auto">
                        <input
                          class="form-control d-flex flex-auto"
                          [ngModel]="appStoreService.accessCode$ | async"
                          (ngModelChange)="changeAccessCode($event)"
                          id="accessCode"
                          name="accessCode"
                          placeholder="Enter access code..."
                          [type]="accessCodeInputFieldType"
                        />
                      </form>
                      <div class="input-group-append">
                        <span class="input-group-text" (click)="toggleAccessCodeInputType()">
                          <i
                            class="bi"
                            [ngClass]="{
                              'bi-eye-slash': accessCodeInputFieldType === 'text',
                              'bi-eye': accessCodeInputFieldType === 'password',
                            }"
                          ></i>
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="list-group-item border-0">
                    <div class="divider-text"><span class="text-secondary">User interface</span></div>
                  </div>
                  <div class="list-group-item border-0 pointer" (click)="resetSideBarWidth()">
                    <i class="bi bi-layout-sidebar-inset me-1"></i> <span style="cursor: pointer">Reset sidebar width</span>
                  </div>
                  <div class="list-group-item border-0">
                    <div class="divider-text my-2"><span class="text-secondary">Local Database</span></div>
                  </div>
                  <div class="list-group-item border-0 pointer" (click)="backupDatabase()">
                    <i class="bi bi-database-down me-1" style="color: cornflowerblue"></i> Backup Database
                    @if (dbBackup.safeURL) {
                      <p>
                        <a class="btn btn-outline-info btn-sm w-100" [href]="dbBackup.safeURL" [download]="dbBackup.filename"
                          ><i class="bi bi-cloud-download-fill"></i> Download</a
                        >
                      </p>
                    }
                  </div>
                  <div class="list-group-item border-0 pointer">
                    <input type="file" class="d-none" #restoreInput (change)="onRestoreFileSelected(restoreInput)" />
                    <div class="w-100" (click)="restoreInput.click()">
                      <i class="bi bi-database-fill-up me-1" style="color: cornflowerblue"></i> Restore Database
                    </div>
                  </div>
                  <div class="list-group-item border-0 pointer" (click)="onClearClick()">
                    <i class="bi bi-eraser me-1" style="color: red"></i>
                    <span style="cursor: pointer; color: red">Clear all data</span>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <ul
    ngbNav
    #nav="ngbNav"
    [(activeId)]="activeMode"
    class="nav-tabs"
    id="mode-tabs"
    [ngClass]="{
      'with-feedback': settingsService.feedbackEnabled,
      'no-feedback': !settingsService.feedbackEnabled,
    }"
  >
    <li [ngbNavItem]="1">
      <button ngbNavLink (mousedown)="changeMode('annotation')">Annotation</button>
      <ng-template ngbNavContent class="d-flex w-100 h-100">
        @if (appStoreService.appInitialized$ | async) {
          <tportal-proceedings
            #proceedings
            (afterdrop)="onAfterDrop($event)"
            [shortcutsEnabled]="settingsService.shortCutsEnabled"
            (feedbackRequested)="onFeedbackRequest($event)"
            (operationclick)="onOperationClick($event)"
            (operationhover)="onOperationHover($event)"
            [isClosed]="sidebarExpand === 'closed'"
            [entries]="modeStoreService.selectedModeEntries$ | async"
            currentMode="annotation"
            [operations]="modeStoreService.selectedModeDefaultOperations$ | async"
            [queue]="preprocessingStoreService.preprocessingQueue$ | async"
            [shortstyle]="sidebarstate === 'opened'"
            style="height: 100%"
          >
          </tportal-proceedings>
        }
      </ng-template>
    </li>
    <li [ngbNavItem]="2">
      <button ngbNavLink (mousedown)="changeMode('summarization')">Summarization &amp; Translation</button>
      <ng-template ngbNavContent class="d-flex w-100 h-100">
        @if (appStoreService.appInitialized$ | async) {
          <tportal-proceedings
            #proceedings
            (afterdrop)="onAfterDrop($event)"
            [shortcutsEnabled]="settingsService.shortCutsEnabled"
            (feedbackRequested)="onFeedbackRequest($event)"
            (operationclick)="onOperationClick($event)"
            (operationhover)="onOperationHover($event)"
            [isClosed]="sidebarExpand === 'closed'"
            [entries]="modeStoreService.selectedModeEntries$ | async"
            currentMode="summarization"
            [operations]="modeStoreService.selectedModeDefaultOperations$ | async"
            [queue]="preprocessingStoreService.preprocessingQueue$ | async"
            [shortstyle]="sidebarstate === 'opened'"
            style="height: 100%"
          >
          </tportal-proceedings>
        }
      </ng-template>
    </li>
  </ul>
  <!-- SUB-HEADER OVERVIEW -->
  @if ((modeStoreService.openedToolOperation$ | async) === undefined || (modeStoreService.openedToolOperation$ | async) === null) {
    <div class="row proceedings-header" style="padding-top: 0">
      <div class="col-4" style="text-align: left; padding-top: 5px">
        <button (click)="onFilesAddButtonClicked()" class="btn btn-primary">
          <i class="bi bi-plus"></i><span class="d-none d-lg-inline d-xl-inline"> 1. ADD FILES</span>
        </button>
        <!-- webkitdirectory directory multiple -->
        <input #fileinput (change)="onFileChange(fileinput)" class="fileinput" multiple style="display: none" type="file" value="Select audio file" />
        <button
          (click)="onVerifyButtonClick()"
          [disabled]="(modeStoreService.currentModeStatistics$ | async)!.queued < 1"
          class="btn btn-primary"
          style="margin-left: 10px"
        >
          <i class="bi bi-clipboard-check-fill"></i>
          <span class="d-none d-lg-inline d-xl-inline"> 2. CHECK OPTIONS</span>
          @if ((modeStoreService.currentModeStatistics$ | async)!.queued > 0) {
            ({{ (modeStoreService.currentModeStatistics$ | async)!.queued }})
          }
        </button>
      </div>
      <div class="col-4">
        <div id="overall-state">
          {{ modeStoreService.currentOverallStateLabel$ | async }}
        </div>
      </div>
      <div class="col-4" style="text-align: right; padding-top: 5px">
        <button
          (click)="onStartClick()"
          [disabled]="
            ((modeStoreService.currentModeStatistics$ | async)?.waiting ?? 0) === 0 &&
            ((modeStoreService.currentModeStatistics$ | async)?.running ?? 0) === 0
          "
          class="btn btn-primary"
        >
          <i
            [ngClass]="{
              'bi-play-fill': (modeStoreService.overallState$ | async) === 'not started',
              'bi-stop-fill': (modeStoreService.overallState$ | async) !== 'not started',
            }"
            aria-hidden="true"
            class="bi"
          ></i
          ><span class="d-none d-lg-inline d-xl-inline">
            @if ((modeStoreService.overallState$ | async) !== 'processing') {
              3. START PROCESSING
            } @else {
              3. STOP PROCESSING
            }
          </span>
        </button>
      </div>
    </div>
  } @else {
    <!-- SUB-HEADER TOOL -->
    <div class="row proceedings-header" style="padding-top: 0; height: 50px">
      <div class="col-2" style="text-align: left; padding-top: 5px">
        <button (click)="onBackButtonClicked()" class="btn btn-primary" style="width: 100%">
          <i aria-hidden="true" class="bi bi-chevron-double-left" style="font-size: 20px"></i>
        </button>
      </div>
      <div class="col-8" style="text-align: center">
        <p style="margin: 10px 0 0">
          {{ toolSelectedOperation?.operation?.name }}: {{ toolSelectedOperation?.audioFile?.attributes?.originalFileName }}, Language:
          {{ toolSelectedOperation?.language }}, Audio duration: {{ toolSelectedOperation?.audioFile?.duration | time }}
        </p>
      </div>
      <div class="col-2" style="text-align: right; padding-top: 5px">
        <button (click)="onBackButtonClicked()" class="btn btn-primary" style="width: 100%">
          <i aria-hidden="true" class="bi bi-chevron-double-right" style="font-size: 20px"></i>
        </button>
      </div>
    </div>
  }
  <!-- WORKING AREA -->
  <div id="main" style="position: relative" class="d-flex">
    <div
      (blur)="onBlur($event)"
      (mousedown)="dragBorder($event, 'left')"
      (mouseenter)="dragBorder($event, 'left')"
      (mouseleave)="dragBorder($event, 'left')"
      (mousemove)="dragBorder($event, 'left')"
      (mouseup)="dragBorder($event, 'left')"
      [@expandLeft]="animationObject2"
      [ngClass]="{
        dragborder: dragborder === 'active' || dragborder === 'dragging',
      }"
      [ngStyle]="{
        width: newProceedingsWidth + '%',
        'border-right': sidebarExpand === 'closed' ? '2px solid lightgray' : 'none',
      }"
      style="float: right"
    >
      <div [ngbNavOutlet]="nav" class="d-flex flex-column flex-auto w-100 h-100 position-relative"></div>
    </div>
    <div
      (mousedown)="dragBorder($event, 'right')"
      (mouseenter)="dragBorder($event, 'right')"
      (mouseleave)="dragBorder($event, 'right')"
      (mousemove)="dragBorder($event, 'right')"
      (mouseup)="dragBorder($event, 'right')"
      [@comeIn]="animationObject"
      [hidden]="dragborder === 'inactive'"
      [ngClass]="{
        dragborder: dragborder === 'active' || dragborder === 'dragging',
      }"
      [ngStyle]="{
        'margin-left': newProceedingsWidth + '%',
        width: newToolWidth + '%',
      }"
      style="position: absolute; height: 100%; z-index: 800"
    ></div>
    <div
      [@comeIn]="animationObject"
      [ngStyle]="{
        'margin-left': newProceedingsWidth + '%',
        width: newToolWidth + '%',
      }"
      style="position: absolute; height: 100%; border-top: 1px solid gray"
    >
      <tportal-tool-loader
        #toolLoader
        (datareceived)="onToolDataReceived($event, toolLoader)"
        [operation]="modeStoreService.openedToolOperation$ | async"
        style="height: 100%"
      ></tportal-tool-loader>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
