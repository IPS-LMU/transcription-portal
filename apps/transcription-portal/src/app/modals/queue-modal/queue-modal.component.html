<div class="modal-header">
  <h4 class="modal-title pull-left">{{ 'modals.check options.title' | transloco }}</h4>
  <button (click)="onSubmit(form)" class="btn btn-outline-primary" style="margin-left: 20px" type="button">{{ 'g.OK' | transloco }}</button>
  <button type="button" class="btn-close pull-right" aria-label="Close" (click)="activeModal.close('Cross click')"></button>
</div>
<div class="modal-body d-flex flex-column h-100">
  <div>
    <p
      style="font-size: 0.9em; text-align: justify; margin-bottom: 0"
      [innerHTML]="'modals.check options.introduction.paragraph1' | transloco: { iIcon: '<i class=\'bi bi-info-circle-fill cornflowerblue\'></i>' }"
    ></p>
    <p style="font-size: 0.9em; text-align: justify; margin-top: 5px" [innerHTML]="'modals.check options.introduction.paragraph1' | transloco"></p>

    <div class="card shadow shadow-md mt-4">
      <div class="card-header">{{ 'g.tasks' | transloco }}</div>
      <div class="card-body">
        <p [innerHTML]="'modals.check options.tasks.description' | transloco"></p>
        @if (isOneAudiofileInvalid()) {
          <div class="alert alert-danger" style="font-size: 0.9em">
            <p [innerHTML]="'modals.check options.tasks.asr provider requirement mismatch' | transloco"></p>
            @if (selectedASRInfo !== undefined) {
              <ul>
                @if (selectedASRInfo.maxSignalSize) {
                  <li>
                    Maximum size of audio file:
                    {{ selectedASRInfo.maxSignalSize }} MB
                  </li>
                }
                @if (selectedASRInfo.maxSignalDuration) {
                  <li>
                    Maximum audio duration:
                    {{ selectedASRInfo.maxSignalDuration * 1000 | time: ['full'] }}
                    (H:m:s)
                  </li>
                }
              </ul>
            }
            <p [innerHTML]="'modals.check options.tasks.incompatible files' | transloco"></p>
          </div>
        }
        @if (orangeCount > 0) {
          <p
            class="alert alert-warning"
            style="text-align: center; font-size: 0.9em"
            [innerHTML]="'modals.check options.tasks.warning readding files' | transloco"
          ></p>
        }

        <table class="table table-responsive-md table-striped" id="queue">
          <thead>
            <tr>
              <th>{{ 'g.valid' | transloco }}?</th>
              <th class="text-start">{{ 'g.file' | transloco }}</th>
              <th>{{ 'g.language' | transloco }}</th>
              @for (operation of operations; track operation.id; let i = $index) {
                <th>
                  <div>
                    @if (operation.title === '') {
                      <span style="display: block">
                        <ng-container>
                          {{ 'operations.' + (operation.name | lowercase) + '.name' | transloco }}
                        </ng-container>
                      </span>
                    } @else {
                      <div [innerHTML]="'operations.' + (operation.title | lowercase) + '.name' | transloco"></div>
                    }
                  </div>
                </th>
              }
            </tr>
            <tr>
              <th class="compatible-col"></th>
              <th></th>
              <th></th>
              <th></th>
              @for (operation of operations; track operation.id; let i = $index) {
                @if (
                  operation.name === 'OCTRA' || operation.name === 'ASR' || operation.name === 'Summarization' || operation.name === 'Translation'
                ) {
                  <th>
                    <input (click)="deactivateOperation(operation, i)" [checked]="operation.enabled" class="header-checkbox" type="checkbox" />
                  </th>
                } @else if (operation.name === 'MAUS') {
                  <th colspan="2" style="position: relative">
                    <img src="assets/directory.png" style="height: 25px; left: 0; position: absolute" />
                    <input (click)="deactivateOperation(operation, i)" [checked]="operation.enabled" class="header-checkbox" type="checkbox" />
                    <img
                      src="assets/directory.png"
                      style="height: 25px; -webkit-transform: scaleX(-1); transform: scaleX(-1); right: 0; position: absolute"
                    />
                  </th>
                }
              }
            </tr>
          </thead>
          <tbody>
            @for (task of tasks; track task.id) {
              @if (task.status === 'QUEUED') {
                <tr>
                  <td class="compatible-col">
                    <ng-template #validationResult>
                      <table class="table table-sm table-striped">
                        <tbody>
                          @for (check of getChecksByID(task.id); track check.name) {
                            <tr>
                              <td>
                                <i
                                  class="bi"
                                  [ngClass]="{
                                    'bi-check-lg': check.isValid,
                                    'bi-x': !check.isValid,
                                  }"
                                  [ngStyle]="{
                                    color: check.isValid ? 'green' : 'red',
                                  }"
                                ></i>
                              </td>
                              <td style="text-align: left">{{ check.name }}:</td>
                              <td style="text-align: left">{{ check.value }}</td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </ng-template>
                    <span
                      #popoverResult="ngbPopover"
                      (mouseenter)="onValidationResultMouseEnter(popoverResult, task.id)"
                      (mouseleave)="popoverResult.close()"
                      triggers=""
                      [ngbPopover]="validationResult"
                      [placement]="'right'"
                    >
                      <i
                        class="bi"
                        [ngClass]="{
                          'bi-check-lg': !isSomethingInvalid(task.id),
                          'fbi-x': isSomethingInvalid(task.id),
                        }"
                        [ngStyle]="{
                          color: isSomethingInvalid(task.id) ? 'red' : 'green',
                        }"
                      ></i>
                    </span>
                  </td>
                  <td class="text-start">
                    <span
                      [ngClass]="{
                        green:
                          (task.files[0].extension === '.wav' && task.files[0].file !== undefined) ||
                          (task.operations[0].rounds.length > 0 && task.operations[0].lastRound?.lastResult?.online),
                        yellow:
                          ((task.files[0].extension === '.wav' && task.files[0].file === undefined) || task.files[0].extension !== '.wav') &&
                          task.operations[0].state !== 'FINISHED',
                        red: isSomethingInvalid(task.id),
                      }"
                      title="{{ task.files[0].attributes.originalFileName }}"
                    >
                      {{ task.files[0].attributes.originalFileName.replace('_annot.json', '.wav') }}
                    </span>
                    @if (task.files.length > 1 || task.files[0].extension !== '.wav') {
                      <span
                        [ngClass]="{
                          'bg-info': getBadge(task).type === 'info',
                          'bg-warning': getBadge(task).type === 'warning',
                        }"
                        class="badge"
                      >
                        {{ getBadge(task).label }}
                      </span>
                    }
                  </td>
                  <td>{{ task.asrOperation.language }}</td>
                  @for (operation of task.operations; track operation.id) {
                    <td>
                      @if (operation.enabled) {
                        <span><i class="bi bi-check-lg" style="color: black"></i></span>
                      }
                      @if (!operation.enabled) {
                        <span>{{ 'g.skip' | transloco }}</span>
                      }
                    </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>

    <div class="card shadow shadow-md">
      <div class="card-header">
        <div class="row g-0 align-items-center">
          <div class="col">{{ 'g.options' | transloco }}</div>
          <div class="col-auto">
            <button class="btn btn-sm btn-outline-primary reset-button" (click)="resetOptions()">
              <i class="bi bi-arrow-counterclockwise"></i> {{ 'p.reset options' | transloco }}
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <p
          [innerHTML]="'modals.check options.options.description' | transloco: { iIcon: '<i class=\'bi bi-info-circle-fill cornflowerblue\'></i>' }"
        ></p>
        <div class="row mb-3">
          <div class="col-md-12">
            <form #form="ngForm">
              <table class="table table-sm table-striped">
                <tbody>
                  <tr>
                    <td class="fit">
                      <label class="mt-2"
                        >{{ 'modals.check options.options.asr service provider.name' | transloco }}<span class="text-danger">*</span>:</label
                      >
                    </td>
                    <td>
                      <octra-asr-provider-select
                        [(ngModel)]="taskService.state.currentModeState.selectedASRProvider"
                        [required]="true"
                        (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                        [asrProviders]="asrProviders"
                        [i18n]="{
                          asrProvider: 'ASR Provider',
                        }"
                        name="asrProvider"
                        id="asrProvider"
                        class="d-block"
                      ></octra-asr-provider-select>

                      @if (selectedASRInfo !== undefined && isASRSelected() && selectedASRInfo.knownIssues !== undefined) {
                        <div class="alert alert-info mt-3" style="font-size: 0.9em">
                          <b>Known Issues for {{ selectedASRInfo.provider }} ASR:</b>
                          {{ selectedASRInfo.knownIssues }}
                        </div>
                      }
                    </td>
                  </tr>
                  <tr class="align-middle">
                    <td class="fit">
                      <label class="me-1"
                        >{{ 'modals.check options.options.content language.name' | transloco }}<span class="text-danger">*</span>:</label
                      >
                    </td>
                    <td>
                      <octra-asr-language-select
                        [(ngModel)]="taskService.state.currentModeState.selectedASRLanguage"
                        (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                        [languageSettings]="{
                          services: AppSettings.configuration.api.services,
                        }"
                        name="asrLanguage"
                        id="asrLanguage"
                        class="d-block"
                        [languages]="languages.asr"
                        [options]="{
                          selectedServiceProvider: taskService.state.currentModeState.selectedASRProvider,
                          selectedASRLanguage: taskService.state.currentModeState.selectedASRLanguage,
                        }"
                        placeholder="Content Language"
                        [title]="'Content Language'"
                        [required]="true"
                      ></octra-asr-language-select>
                      <span class="d-block small mute text-secondary ms-1" style="font-size: 0.75rem">{{
                        'modals.check options.options.content language.help' | transloco
                      }}</span>
                    </td>
                  </tr>
                  @if (taskService.state.currentMode === 'annotation') {
                    <tr>
                      <td class="fit">
                        <label class="me-1" for="diarizationSwitch">{{ 'modals.check options.options.diarization.name' | transloco }}:</label>
                      </td>
                      <td>
                        <div class="form-check form-switch">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            role="switch"
                            id="diarizationSwitch"
                            name="diarization"
                            [(ngModel)]="taskService.state.currentModeState.isDiarizationEnabled"
                            (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                          />
                        </div>
                      </td>
                    </tr>
                  }
                  @if (taskService.state.currentModeState.isDiarizationEnabled) {
                    <tr>
                      <td class="fit">
                        <label class="me-1" for="diarizationSwitch">{{ 'modals.check options.options.number of speakers.name' | transloco }}:</label>
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control form-control-sm"
                          name="diarizationNumOfSpeakers"
                          [(ngModel)]="taskService.state.currentModeState.diarizationSpeakers"
                          (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                        />
                      </td>
                    </tr>
                  }
                  @if (taskService.state.currentMode === 'summarization') {
                    <tr class="align-middle fit">
                      <td class="fit">
                        <label for="asrProvider"
                          >{{ 'modals.check options.options.summarization service provider.name' | transloco
                          }}<span class="text-danger">*</span>:</label
                        >
                      </td>
                      <td>
                        <octra-asr-provider-select
                          [(ngModel)]="taskService.state.currentModeState.selectedSummarizationProvider"
                          (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                          [asrProviders]="summarizationProviders"
                          [title]="'modals.check options.options.summarization service provider.name' | transloco"
                          [required]="true"
                          name="summarizationProvider"
                          id="summarizationProvider"
                          class="d-block"
                          [i18n]="{
                            asrProvider: 'modals.check options.options.summarization service provider.name' | transloco,
                          }"
                        ></octra-asr-provider-select>
                      </td>
                    </tr>
                    <tr class="align-middle fit">
                      <td class="fit">
                        <label for="asrProvider"
                          >{{ 'modals.check options.options.number of words.name' | transloco }}<span class="text-danger">*</span>:</label
                        >
                      </td>
                      <td>
                        <select
                          class="form-select form-select-sm"
                          name="summarizationNumberOfWords"
                          [(ngModel)]="selectedSummarizationNumberOfWords"
                          (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                        >
                          <option [value]="">{{ 'modals.check options.options.number of words.values.unlimited' | transloco }}</option>
                          <option [value]="10">{{ 'modals.check options.options.number of words.values.headline' | transloco }}</option>
                          <option [value]="100">{{ 'modals.check options.options.number of words.values.paragraph' | transloco }}</option>
                          <option [value]="400">{{ 'modals.check options.options.number of words.values.page' | transloco }}</option>
                        </select>
                      </td>
                    </tr>
                  }
                  @if (taskService.state.currentMode === 'annotation') {
                    <tr class="align-middle fit">
                      <td class="fit">
                        <label>{{ 'modals.check options.options.word alignment language.name' | transloco }}:</label>
                      </td>
                      <td>
                        <octra-asr-language-select
                          [(ngModel)]="taskService.state.currentModeState.selectedMausLanguage"
                          (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                          [languageSettings]="{
                            services: AppSettings.configuration.api.services,
                          }"
                          [languages]="languages.maus"
                          [title]="'modals.check options.options.word alignment language.name' | transloco"
                          name="mausLanguage"
                          id="mausLanguage"
                          [placeholder]="'modals.check options.options.word alignment language.name' | transloco"
                        ></octra-asr-language-select>
                      </td>
                    </tr>
                  } @else {
                    <tr class="align-middle">
                      <td class="fit">
                        <label>{{ 'modals.check options.options.translation language.name' | transloco }}:</label>
                      </td>
                      <td>
                        <div class="row g-1 align-items-center">
                          <div class="col">
                            <select
                              class="form-select form-select-sm"
                              [(ngModel)]="taskService.state.currentModeState.selectedTranslationLanguage"
                              name="translationLanguage"
                              [required]="true"
                              (ngModelChange)="changeProcessingOptionsForEachQueuedTask()"
                            >
                              <option value=""></option>
                              <option value="en">{{ 'languages.en' | transloco }}</option>
                              <option value="de">{{ 'languages.de' | transloco }}</option>
                              <option value="nl">{{ 'languages.nl' | transloco }}</option>
                              <option value="it">{{ 'languages.it' | transloco }}</option>
                            </select>
                            <ng-template #translationProviderInfo>
                              <div>
                                <span class="d-block text-center"
                                  >{{ 'modals.check options.options.translation language.provided by' | transloco }}:</span
                                >
                                <a [href]="settingsService.translationServiceProvider?.homepageURL" target="_blank"
                                  ><img [src]="settingsService.translationServiceProvider?.logoURL" class="img-fluid"
                                /></a>
                              </div>
                            </ng-template>
                          </div>
                          <div class="col-auto">
                            <i class="bi bi-info-circle-fill pointer" style="color: cornflowerblue" [ngbPopover]="translationProviderInfo"></i>
                          </div>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-outline-dark" (click)="activeModal.close()">{{ 'g.cancel' | transloco }}</button>
  <button
    (click)="onSubmit(form)"
    class="btn btn-outline-primary"
    type="button"
    [ngbPopover]="errorPopoverContent"
    [popoverClass]="'error-popover'"
    #okPopover="ngbPopover"
    triggers="manual"
  >
    {{ 'g.OK' | transloco }}
  </button>
</div>
<ng-template #errorPopoverContent> {{'modals.check options.missing fields' | transloco"}} </ng-template>
